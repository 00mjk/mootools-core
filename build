#!/usr/bin/env php

<?php

$stderr = fopen('php://stderr', 'w');

require dirname(__FILE__) . '/Packager/packager.php';

$executable = array_shift($argv);
$package = dirname(__FILE__);

$pkg = new Packager($package);

fwrite($stderr, "\nPackager is building $package\n\n");
fwrite($stderr, "Included Components:\n");

$no_compat = false;

foreach ($argv as $arg){
	if ($arg == '-1.2compat'){
		array_erase($argv, $arg);
		$no_compat = true;
		break;
	}
}

$files = (empty($argv)) ? $pkg->get_all_files() : $pkg->components_to_files($argv);

foreach ($files as $file){
	fwrite($stderr, "- $file: [" . implode(", ", $pkg->get_file_provides($file)) . "]\n");
}

fwrite($stderr, "\n");

$output = $pkg->build_from_files($files);

function remove_tag($tag, $output){
	$tag = preg_quote($tag);
	$output = preg_replace("%/\*<${tag}>.*?</${tag}>\*/%s", '', $output);
	$output = preg_replace("%//<${tag}>.*?//</${tag}>%s", '', $output);
	return $output;
}

function remove_comment_tag($tag, $output){
	$tag = preg_quote($tag);
	$output = preg_replace("%/\*<${tag}>\*/(.*?)/\*</${tag}>\*/%s", '$1', $output);
	$output = preg_replace("%//<${tag}>(.*?)//</${tag}>%s", '$1', $output);
	return $output;
}

if ($no_compat){
	$output = remove_tag('1.2compat', $output);
	$output = remove_comment_tag('1.3only', $output);
} else {
	$output = remove_tag('1.3only', $output);
}

echo $output;

fclose($stderr);

?>
